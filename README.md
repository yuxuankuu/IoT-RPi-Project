# â€œWakeWakeâ€ é§•é§›äººç¡æ„åµæ¸¬è­¦ç¤ºç³»çµ±

Author:
é‚±è£•è»’ Yuhsuan Chiu (https://github.com/yuxuankuu/)
112453013 (StudentID)
---

# å°ˆæ¡ˆç°¡ä»‹

æœ¬å°ˆæ¡ˆé€é IoT èˆ‡ Raspberry Piï¼Œå¯¦ç¾é§•é§›äººç¡æ„åµæ¸¬è­¦ç¤ºç³»çµ±ï¼Œç‚ºäº†è§£æ±ºç–²å‹é§•é§›ç”¢ç”Ÿçš„æ„å¤–å‚·æ•…ï¼Œé€éç–²å‹é§•é§›åµæ¸¬ã€è­¦ç¤ºæ§åˆ¶ï¼Œä»¥åŠæä¾›æ•¸æ“šå¯è¦–åŒ–åŠŸèƒ½ã€‚

## ä¸»è¦ç›®æ¨™

- ä½¿ç”¨æ¨¹è“æ´¾é€£æ¥é¡é ­ï¼Œé€éå½±åƒè¾¨è­˜å‡ºä¸€äº›ç‰¹å®šè¡Œç‚ºï¼ˆå¦‚é–‰çœ¼ç›ã€æ‰“å“ˆæ¬ ç­‰ï¼‰ã€‚
- è§€å¯Ÿç¡æ„è¡Œç‚ºé€²è¡Œè¦–è¦ºåŠè½è¦ºè­¦ç¤ºã€‚
- æä¾›æ„Ÿæ¸¬è³‡æ–™æä¾›å¾ŒçºŒåˆ†æã€‚

## æ‡‰ç”¨æƒ…å¢ƒ

- é§•é§›äººå¸¸éœ€é€²è¡Œæ•¸å°æ™‚ç”šè‡³æ•¸åå°æ™‚çš„é•·é€”é§•é§›ï¼Œå°¤å…¶æ˜¯å¤œé–“è¡Œè»Šã€‚
- é é˜²ç–²å‹é§•é§›äº‹æ•…ï¼Œé™ä½äººå“¡å‚·äº¡ã€‚
- è¨˜éŒ„ç–²å‹é§•é§›æ•¸æ“šï¼Œæä¾›å¯é‡åŒ–çš„è³‡æ–™æ¸¬é‡è¨˜éŒ„ã€‚

**1è‡³10æœˆåœ‹é“æ­»äº¡è‡ªæ’å 37% å¤šå› æç¥ã€ç–²å‹é§•é§›**

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image.png)

äº¤é€šéƒ¨é«˜é€Ÿå…¬è·¯å±€çµ±è¨ˆï¼Œ113å¹´1æœˆè‡³10æœˆåœ‹é“å·²ç™¼ç”Ÿ57èµ·æ­»äº¡äº¤é€šäº‹æ•…ï¼Œå…¶ä¸­è‚‡äº‹å‹æ…‹å±¬æ–¼ã€Œè‡ªæ’ã€ç‚º21ä»¶ï¼ˆå 37%ï¼‰ï¼Œè‚‡å› æœ€å¤šç‚ºæç¥ã€åˆ†å¿ƒã€ç–²å‹é§•é§›ç­‰ã€‚ï¼ˆé«˜å…¬å±€æä¾›ï¼‰

## ç³»çµ±åŠŸèƒ½

### è¦–è¦ºåµæ¸¬

ç”¨è¦–è¦ºè¾¨è­˜åµæ¸¬çœ¼ç›å’Œå˜´å”‡é–‰åˆç‹€æ…‹

### è­¦å ±æç¤º

è§¸ç™¼è­¦ç¤ºç‡ˆå’Œèœ‚é³´å™¨è²éŸ³è­¦å ±

### åˆ†æå ±è¡¨

åœ¨ç¶²é ä¸Šé¡¯ç¤ºé§•é§›ç‹€æ…‹ä»¥æ—¥æœŸæ™‚é–“ç‚ºè¨˜éŒ„

## ç³»çµ±æ¶æ§‹

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_1.png)

### **ç¡¬é«”éœ€æ±‚**

- **æ¨¹è“æ´¾å‹è™Ÿ**ï¼šRaspberry Pi 4 æˆ–ä»¥ä¸Šç‰ˆæœ¬
- **å¤–éƒ¨è£ç½®**ï¼š
    - Pi Camera é¡é ­æ¨¡çµ„
    - ä¸ƒæ®µé¡¯ç¤ºå™¨ (Optional)
    - LED å…ƒä»¶å’Œé›»é˜»
    - èœ‚é³´å™¨
    - SD Card (è‡³å°‘32GBï¼Œç”¨æ–¼æ—¥èªŒè¨˜éŒ„å’Œå‚™ä»½)
    - é›»æºä¾›æ‡‰å™¨
    - éºµåŒ…æ¿

### **è»Ÿé«”æŠ€è¡“**

- **èªè¨€æ¡†æ¶**ï¼š
    - Python 3.7 æˆ–ä»¥ä¸Šç‰ˆæœ¬
    - Flaskï¼ˆå¾Œç«¯ API é–‹ç™¼ï¼‰
- **å‡½å¼åº«**ï¼š
    - `dlib`ï¼šæ©Ÿå™¨å­¸ç¿’ã€äººè‡‰åµæ¸¬
    - `gpiozero`ï¼šGPIO æ§åˆ¶
    - `cv2`ï¼šOpenCVå½±åƒè™•ç†
    - `numpy`ï¼šæ•¸æ“šè™•ç†
    - `matplotlib`ï¼šæ•¸æ“šå¯è¦–åŒ–

### Diagram

(ä½¿ç”¨ [fritzing](https://fritzing.org/) ç¹ªè£½)

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_2.png)

### ç³»çµ±ç¤ºæ„åœ–

å°‡æ¨¹è“æ´¾å®‰è£åœ¨è»Šå…§ï¼Œä½¿é¡é ­é¢å°é§•é§›äººä½ç½®å®‰è£åœ¨æ–¹å‘ç›¤å¾Œæ–¹ã€‚

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/demo_1.jpg)

åµæ¸¬ç³»çµ±å•Ÿå‹•æ™‚(ç¶ è‰²LEDé–ƒçˆ)ä¸¦å‡ºç¾æ­¡è¿èª"HELLO"ï¼Œåµæ¸¬ç³»çµ±é‹è¡Œä¸­(ç¶ è‰²LEDæ†äº®)ã€‚

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/demo_2.jpg)


# å¯¦ä½œç¯„ä¾‹

## 1. ç’°å¢ƒå®‰è£

### ä½œæ¥­ç³»çµ±å®‰è£

é€é **RaspberryÂ PiÂ Imager** (æŒ‰æ­¤[é€£çµ](https://www.raspberrypi.com/software/)ä¸‹è¼‰ä¸¦å®‰è£) å°‡ Raspberry Pi ä½œæ¥­ç³»çµ±å®‰è£åˆ° microSD å¡ï¼Œæ­¤ç¯„ä¾‹ä½¿ç”¨é å…ˆæº–å‚™çš„ Image **`2021-05-07-raspios-buster-armhf.img`ã€‚**

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_3.png)

### ç³»çµ±å’Œå¥—ä»¶æ›´æ–°

é€é RealVNC ç™»å…¥ Raspberry Pi ç³»çµ±å¾Œï¼Œé€²è¡Œè»Ÿé«”æ›´æ–°ä»¥åŠç›¸é—œæ“ä½œã€‚

```bash
sudo apt update && sudo apt upgrade -y
```

å®‰è£åŸºæœ¬é–‹ç™¼å·¥å…·

- æ¨¹è“æ´¾é€šå¸¸è‡ªå¸¶ Pythonï¼Œä½†éœ€è¦ç¢ºèªä¸¦å®‰è£æ‰€éœ€ç‰ˆæœ¬ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æª¢æŸ¥å¥—ä»¶ç‰ˆæœ¬ï¼š
    
    ```bash
    python3 --version
    pip3 list
    ```
    
- æ¨¹è“æ´¾ä¸Šé‹è¡Œ dlib å’Œ OpenCV éœ€è¦ CMake å’Œå…¶ä»–é–‹ç™¼å·¥å…· (åƒè€ƒ Ref #1)ï¼š
    
    ```bash
    cd ~/
    wget https://github.com/Kitware/CMake/releases/download/v3.14.4/cmake-3.14.4.tar.gz
    tar xvzf cmake-3.14.4.tar.gz
    cd ~/cmake-3.14.4
    ./bootstrap
    ```
    
    æˆåŠŸç•«é¢ï¼š
    
    ![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/result_1.png)
    
    åŸ·è¡Œç·¨è­¯ï¼š
    
    ```bash
    make -j4
    ```
    
    æˆåŠŸç•«é¢ï¼š
    
    ![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/result_2.png)
    
    åŸ·è¡Œå®‰è£ï¼š
    
    ```bash
    sudo make install
    ```
    
    æˆåŠŸç•«é¢ï¼š
    
    ![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/result_3.png)
    
- å®‰è£ dlib å’Œ OpenCV
    
    ```bash
    pip3 install dlib
    pip3 install opencv-python
    ```
    
- å®‰è£å…¶ä»– Dependencies
    
    ```bash
    pip3 install numpy scipy imutils flask
    ```
    

### æº–å‚™æ¨¡å‹

åˆ° Dlib Library [http://dlib.net/files/](http://dlib.net/files/) ä¸‹è¼‰äººè‡‰ç‰¹å¾µé»æ¨¡å‹ **shape_predictor_68_face_landmarks.dat**  (åƒè€ƒ Ref #2)

`shape_predictor_68_face_landmarks.dat`æ˜¯ç”± Dlib Library æä¾›çš„é è¨“ç·´æ¨¡å‹ï¼Œå°ˆé–€ç”¨æ–¼äººè‡‰ç‰¹å¾µé»æª¢æ¸¬ã€‚å®ƒå¯ä»¥è­˜åˆ¥äººè‡‰ä¸Šçš„ 68 å€‹ç‰¹å¾µé»ï¼Œä¾‹å¦‚çœ¼ç›ã€çœ‰æ¯›ã€é¼»å­ã€å˜´å·´å’Œä¸‹å·´çš„é—œéµä½ç½®ã€‚é€™äº›ç‰¹å¾µé»å¸¸ç”¨æ–¼äººè‡‰è­˜åˆ¥ã€è¡¨æƒ…åˆ†æã€è‡‰éƒ¨ç‰¹å¾µå°é½Šç­‰æ‡‰ç”¨ã€‚

![**The 68 landmarks detected by dlib library. This image was created by Brandon Amos of CMU who works on OpenFace.**](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_4.png)

**The 68 landmarks detected by dlib library. This image was created by Brandon Amos of CMU who works on OpenFace.**

```bash
wget http://dlib.net/files/shape_predictor_68_face_landmarks.dat.bz2
bzip2 -d shape_predictor_68_face_landmarks.dat.bz2
```

ç¢ºä¿æ­¤æ–‡ä»¶èˆ‡ç¨‹å¼ç¢¼æ”¾åœ¨ç›¸åŒç›®éŒ„ä¸‹ã€‚

<aside>
ğŸ’¡

è‡‰éƒ¨æ¨¡å‹æ¸¬è©¦æŠŠçœ¼é¡æ‹¿ä¸‹ä¾†è­˜åˆ¥ç²¾ç¢ºåº¦å¤§å¹…æå‡ã€‚

</aside>

**çœ¼ç›è·é›¢æ¯” EARï¼ˆEye Aspect Ratioï¼‰è¨ˆç®—** (åƒè€ƒ Ref #3)

åˆ¤æ–·çœ¼ç›æ˜¯å¦é–‰åˆçš„è¨ˆç®—å…¬å¼ï¼Œå¯ä»¥ç”¨çœ¨çœ¼çš„æª¢æ¸¬ã€‚

```python
def eye_aspect_ratio(eye):
    A = dist.euclidean(eye[1], eye[5]) #çœ¼ç›å‚ç›´è·é›¢
    B = dist.euclidean(eye[2], eye[4]) #çœ¼ç›å‚ç›´è·é›¢
    C = dist.euclidean(eye[0], eye[3]) #çœ¼ç›æ°´å¹³è·é›¢

    ear = (A + B) / (2.0 * C)

    return ear
```

### å®‰è£é¡é ­

 (åƒè€ƒ Ref #4)

1. ç¢ºä¿ Raspberry Pi å·²é—œæ©Ÿã€‚ 
2. æ‰¾åˆ°é¡é ­æ¨¡çµ„æ¥å£ï¼Œè¼•è¼•æ‹‰èµ·ç«¯å£å¡‘è† å¤¾çš„é‚Šç·£ï¼Œæ’å…¥é¡é ­æ¨¡çµ„å¸¶ç‹€é›»çºœã€‚
3. ç¢ºä¿å¸¶ç‹€é›»çºœåº•éƒ¨çš„é€£æ¥å™¨é¢å‘é€£æ¥åŸ ä¸­çš„æ¥é»ï¼Œå°‡å¡‘è† å¤¾æ¨å›åŸä½ã€‚
4. é‡æ–°å•Ÿå‹• Raspberry Piã€‚

åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤æ¸¬è©¦ Camera åŠŸèƒ½ï¼š

```bash
raspistill -o ~/Desktop/test.jpg
```

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_5.gif)

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_6.png)

### å®‰è£å…¶ä»–å…ƒä»¶

å¢åŠ ä¸ƒæ®µé¡¯ç¤ºå™¨ç·šè·¯ (ä½¿ç”¨ [tinkercad](http://www.tinkercad.com) ç¹ªè£½)

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_7_1.png)

![image.jpg](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_7_2.jpg)

## 2. åŸ·è¡Œç¨‹å¼

åŸ·è¡Œåµæ¸¬ç¨‹å¼ï¼š

```bash
python3 drowsiness_yawn.py
```

![image.jpg](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_8.jpg)

åŸ·è¡Œå¾Œå°ç¨‹å¼ app.pyï¼Œç”¨ Flask å¯¦ä½œè®€å–ç–²å‹å’Œå’Œæ‰“å“ˆæ¬ è­¦å‘Šå¯«å…¥æ—¥èªŒæª”æ¡ˆ`alert_log.log`ï¼Œä¸¦è£½ä½œæˆçµ±è¨ˆå ±å‘Šï¼Œä»¥æ–¹ä¾¿å¾ŒçºŒåˆ†ææ‡‰ç”¨ï¼Œå¯ä»¥åšç‚ºé§•é§›äººèª¿åº¦åƒè€ƒã€‚

```bash
python3 app.py
```

![image.png](https://github.com/yuxuankuu/IoT-RPi-Project/blob/main/image/image_9.png)

# æ”¹é€²å»ºè­°

- ç›®å‰çš„ä»‹é¢è¼ƒç‚ºç°¡å–®ï¼Œä½¿ç”¨ CSS æˆ– Bootstrap ä¾†æå‡é é¢ç¾è§€ã€‚
- ä½¿ç”¨ Bar Chart åœ–è¡¨æˆ–å„€æ¿è¡¨ä¾†é¡¯ç¤ºè­¦å ±æ¬¡æ•¸çš„åˆ†ä½ˆã€‚
- å¢åŠ é¡å¤–åŠŸèƒ½ï¼šé…’ç²¾æ¸¬è©¦
å°é§•é§›è€…çš„é…’ç²¾æ¸¬è©¦æ¨¡çµ„ï¼Œä¸¦å°‡æª¢æ¸¬çµæœèˆ‡ç–²å‹æª¢æ¸¬çµåˆï¼Œæä¾›æ›´å…¨é¢çš„ç›£æ§ã€‚

---

# åƒè€ƒ References

1. **æ¢è—é˜ Openvino with NCS2 ON Raspi-4** [https://hackmd.io/HV6hQ2PHSiWlrRsfxC10SA](https://hackmd.io/HV6hQ2PHSiWlrRsfxC10SA)
2. **åŸºäºopencvå’Œshape_predictor_68_face_landmarks.datçš„äººè„¸è¯†åˆ«ç›‘æµ‹** [https://blog.csdn.net/monster663/article/details/118341515](https://blog.csdn.net/monster663/article/details/118341515)
3. **python dlibå­¦ä¹ ï¼ˆåä¸€ï¼‰ï¼šçœ¨çœ¼æ£€æµ‹** [https://blog.csdn.net/hongbin_xu/article/details/79033116](https://blog.csdn.net/hongbin_xu/article/details/79033116)
4. **Connect the Camera Module** [https://projects.raspberrypi.org/en/projects/getting-started-with-picamera/2](https://projects.raspberrypi.org/en/projects/getting-started-with-picamera/2)